// plane_game_fixed.c
// Versi fix lengkap SDL2 Plane Game
// Dependencies: SDL2, SDL2_image, SDL2_mixer, SDL2_ttf

#include <SDL2/SDL.h>
#include <SDL2/SDL_image.h>
#include <SDL2/SDL_mixer.h>
#include <SDL2/SDL_ttf.h>
#include <stdbool.h>
#include <stdlib.h>
#include <time.h>
#include <stdio.h>

#define WIDTH 1000
#define HEIGHT 800
#define FPS 60

#define MAX_PLAYER_BULLETS 256
#define MAX_ENEMY_BULLETS 128
#define MAX_ENEMIES 64

typedef struct {
    SDL_Texture *tex;
    int w,h;
} Image;

typedef struct {
    float x,y;
    float vx;
    int w,h;
    int health;
    int damage;
    bool alive;
    Image *img;
} Enemy;

typedef struct {
    float x,y;
    float vx;
    int w,h;
    int damage;
    bool alive;
} Bullet;

typedef struct {
    float x,y;
    int w,h;
    int health;
    int powerup;
    float fuel;
    bool alive;
    Image *img;
} Player;

typedef enum { HOME, GAME, SCORE } GameState;

// Globals
SDL_Window *win = NULL;
SDL_Renderer *ren = NULL;
Mix_Music *music = NULL;
Mix_Chunk *fx_shoot = NULL, *fx_click = NULL, *fx_collision = NULL, *fx_blast = NULL, *fx_fuel = NULL;
TTF_Font *font_large = NULL;
TTF_Font *font_small = NULL;

Image img_plane = {0}, img_logo = {0}, img_fighter = {0};
Image img_enemies[3][2] = {0}; // fixed array size 3x2

Player player;
Bullet player_bullets[MAX_PLAYER_BULLETS];
Bullet enemy_bullets[MAX_ENEMY_BULLETS];
Enemy enemies[MAX_ENEMIES];

int score = 0;
int level = 1;
int plane_destroy_count = 0;
Uint32 last_enemy_spawn = 0;
Uint32 plane_frequency = 3000; // ms
bool invincible = false;
bool moving_left = false, moving_right = false;
GameState state = HOME;
bool sound_on = true;

// Utility: load texture
Image load_image(const char *path){
    Image im = {0};
    SDL_Surface *surf = IMG_Load(path);
    if(!surf){
        printf("IMG_Load error: %s -> %s\n", path, IMG_GetError());
        return im;
    }
    im.tex = SDL_CreateTextureFromSurface(ren, surf);
    im.w = surf->w; im.h = surf->h;
    SDL_FreeSurface(surf);
    return im;
}

// Draw texture
void draw_image(Image *im, int x, int y){
    if(!im->tex) return;
    SDL_Rect dst = { x, y, im->w, im->h };
    SDL_RenderCopy(ren, im->tex, NULL, &dst);
}

// Init game objects
void init_game(){
    player.x = WIDTH/2 - 80;
    player.y = HEIGHT - 80;
    player.w = 32; player.h = 32;
    player.health = 100;
    player.fuel = 100;
    player.powerup = 0;
    player.alive = true;
    player.img = &img_plane;

    for(int i=0;i<MAX_PLAYER_BULLETS;i++) player_bullets[i].alive = false;
    for(int i=0;i<MAX_ENEMY_BULLETS;i++) enemy_bullets[i].alive = false;
    for(int i=0;i<MAX_ENEMIES;i++) enemies[i].alive = false;

    score = 0;
    level = 1;
    plane_destroy_count = 0;
    last_enemy_spawn = SDL_GetTicks();
}

// Spawn enemy
void spawn_enemy(int type){
    for(int i=0;i<MAX_ENEMIES;i++){
        if(!enemies[i].alive){
            Enemy *e = &enemies[i];
            e->alive = true;
            e->x = rand() % (WIDTH - 48);
            e->y = -50 - (rand()%100);
            e->w = 48; e->h = 48;

            switch(type){
                case 1: e->health = 20; e->vx = 0.5f + (rand()%50)/100.0f; break;
                case 2: e->health = 30; e->vx = 0.7f + (rand()%50)/100.0f; break;
                case 3: e->health = 50; e->vx = 1.0f + (rand()%50)/100.0f; break;
                default: e->health = 25; e->vx = 0.6f; break;
            }
            e->damage = 10;
            int var = rand()%2;
            e->img = &img_enemies[type-1][var]; // type-1 sesuai array
            break;
        }
    }
}

// Player shooting
void shoot_bullets(){
    int spread = (player.powerup > 0) ? 3 : 0;
    int cheat_spread = invincible ? 5 : 0;
    int center_x = (int)(player.x + player.w/2);
    int base_y = (int)player.y;

    for(int dx=-spread; dx<=spread; dx++){
        for(int i=0;i<MAX_PLAYER_BULLETS;i++){
            if(!player_bullets[i].alive){
                player_bullets[i].alive = true;
                player_bullets[i].x = center_x;
                player_bullets[i].y = base_y;
                player_bullets[i].vx = dx * 0.6f;
                player_bullets[i].w = 6; player_bullets[i].h = 12;
                player_bullets[i].damage = 10;
                break;
            }
        }
    }

    if(!invincible && player.powerup>0) player.powerup--;
    if(fx_shoot && sound_on) Mix_PlayChannel(-1, fx_shoot, 0);
}

// Enemy shooting
void enemy_shoot(Enemy *e){
    for(int i=0;i<MAX_ENEMY_BULLETS;i++){
        if(!enemy_bullets[i].alive){
            enemy_bullets[i].alive = true;
            enemy_bullets[i].x = e->x + e->w/2;
            enemy_bullets[i].y = e->y + e->h;
            enemy_bullets[i].vx = 0;
            enemy_bullets[i].w = 6; enemy_bullets[i].h = 12;
            enemy_bullets[i].damage = e->damage;
            break;
        }
    }
}

// Collision detection
bool rect_collide(float x1,float y1,int w1,int h1, float x2,float y2,int w2,int h2){
    return !(x1 + w1 < x2 || x1 > x2 + w2 || y1 + h1 < y2 || y1 > y2 + h2);
}

// HUD
void draw_hud(){
    SDL_Rect r_fuel = {30, 20, (int)player.fuel, 10};
    SDL_SetRenderDrawColor(ren, player.fuel <= 40 ? 255 : 0, player.fuel <= 40 ? 0 : 255, 0, 255);
    SDL_RenderFillRect(ren, &r_fuel);
    SDL_SetRenderDrawColor(ren, 255,255,255,255);
    SDL_Rect frame = {30,20,100,10};
    SDL_RenderDrawRect(ren, &frame);

    SDL_Rect r_hp = {30, 32, player.health, 10};
    SDL_SetRenderDrawColor(ren, 0,0,255,255);
    SDL_RenderFillRect(ren, &r_hp);
    SDL_SetRenderDrawColor(ren, 255,255,255,255);
    SDL_Rect f2 = {30,32,100,10};
    SDL_RenderDrawRect(ren, &f2);

    char buf[64];
    snprintf(buf, sizeof(buf), "Score: %d", score);
    SDL_Color col = {255,0,0,255};
    if(font_small){
        SDL_Surface *surf = TTF_RenderText_Solid(font_small, buf, col);
        if(surf){
            SDL_Texture *tex = SDL_CreateTextureFromSurface(ren, surf);
            SDL_Rect dst = { WIDTH - surf->w - 10, 8, surf->w, surf->h };
            SDL_RenderCopy(ren, tex, NULL, &dst);
            SDL_DestroyTexture(tex);
            SDL_FreeSurface(surf);
        }
    }
}

// Reset
void reset_game(){
    for(int i=0;i<MAX_PLAYER_BULLETS;i++) player_bullets[i].alive = false;
    for(int i=0;i<MAX_ENEMY_BULLETS;i++) enemy_bullets[i].alive = false;
    for(int i=0;i<MAX_ENEMIES;i++) enemies[i].alive = false;
    init_game();
}

// MAIN
int main(int argc, char *argv[]){
    srand((unsigned int)time(NULL));
    if(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER) != 0){ printf("SDL_Init: %s\n", SDL_GetError()); return 1; }
    if(!(IMG_Init(IMG_INIT_PNG) & IMG_INIT_PNG)){ printf("IMG_Init: %s\n", IMG_GetError()); }

    if(Mix_OpenAudio(44100, MIX_DEFAULT_FORMAT, 2, 2048) < 0){ printf("Mix_OpenAudio: %s\n", Mix_GetError()); }
    if(TTF_Init() != 0){ printf("TTF_Init: %s\n", TTF_GetError()); }

    win = SDL_CreateWindow("Plane Game (SDL2)", SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED, WIDTH, HEIGHT, SDL_WINDOW_SHOWN);
    ren = SDL_CreateRenderer(win, -1, SDL_RENDERER_ACCELERATED | SDL_RENDERER_PRESENTVSYNC);

    // Load resources
    img_plane = load_image("assets/images/player1.png");
    img_logo = load_image("assets/images/logo.png");
    img_fighter = load_image("assets/images/fighter.png");

    img_enemies[0][0] = load_image("assets/images/enemies/enemy1-1.png");
    img_enemies[0][1] = load_image("assets/images/enemies/enemy1-2.png");
    img_enemies[1][0] = load_image("assets/images/enemies/enemy2-1.png");
    img_enemies[1][1] = load_image("assets/images/enemies/enemy2-2.png");
    img_enemies[2][0] = load_image("assets/images/enemies/enemy3-1.png");
    img_enemies[2][1] = load_image("assets/images/enemies/enemy3-2.png");

    fx_shoot = Mix_LoadWAV("assets/audio/gunshot.wav");
    fx_click = Mix_LoadWAV("assets/audio/click.wav");
    fx_collision = Mix_LoadWAV("assets/audio/mini_exp.wav");
    fx_blast = Mix_LoadWAV("assets/audio/blast.wav");
    fx_fuel = Mix_LoadWAV("assets/audio/fuel.wav");
    music = Mix_LoadMUS("assets/audio/Defrini - Spookie.mp3");

    font_large = TTF_OpenFont("assets/fonts/ghostclan.ttf", 28);
    font_small = TTF_OpenFont("assets/fonts/DroneflyRegular-K78LA.ttf", 18);

    if(music && sound_on) Mix_PlayMusic(music, -1);
    Mix_VolumeMusic(32);

    init_game();

    Uint32 ticks_per_frame = 1000 / FPS;
    bool running = true;

    while(running){
        Uint32 frame_start = SDL_GetTicks();
        SDL_Event event;
        while(SDL_PollEvent(&event)){
            if(event.type == SDL_QUIT) running = false;
            if(event.type == SDL_KEYDOWN){
                SDL_Keycode k = event.key.keysym.sym;
                if(k == SDLK_ESCAPE || k == SDLK_q) running = false;
                if(k == SDLK_c){ invincible = !invincible; printf("Cheat: %s\n", invincible? "ON":"OFF"); }
                if(state == GAME){
                    if(k == SDLK_LEFT) moving_left = true;
                    if(k == SDLK_RIGHT) moving_right = true;
                    if(k == SDLK_SPACE) shoot_bullets();
                } else if(state == HOME && k==SDLK_SPACE){
                    state = GAME; reset_game();
                }
            }
            if(event.type == SDL_KEYUP){
                if(event.key.keysym.sym == SDLK_LEFT) moving_left = false;
                if(event.key.keysym.sym == SDLK_RIGHT) moving_right = false;
            }
        }

        // GAME LOGIC
        if(state == GAME){
            Uint32 now = SDL_GetTicks();
            if(now - last_enemy_spawn >= plane_frequency){
                int type = (level-1)%3 + 1; // 1..3
                spawn_enemy(type);
                last_enemy_spawn = now;
            }

            if(plane_destroy_count && plane_destroy_count % 5 == 0 && level < 5){ level++; plane_destroy_count=0; }
            if(!invincible) player.fuel -= 0.05f;
            if(moving_left) player.x -= 3.5f;
            if(moving_right) player.x += 3.5f;
            if(player.x < 0) player.x = 0;
            if(player.x + player.w > WIDTH) player.x = WIDTH - player.w;

            for(int i=0;i<MAX_PLAYER_BULLETS;i++){
                if(player_bullets[i].alive){
                    player_bullets[i].y -= 6;
                    player_bullets[i].x += player_bullets[i].vx;
                    if(player_bullets[i].y < -20 || player_bullets[i].x < -50 || player_bullets[i].x > WIDTH+50) player_bullets[i].alive=false;
                }
            }

            for(int i=0;i<MAX_ENEMIES;i++){
                if(enemies[i].alive){
                    enemies[i].y += enemies[i].vx;
                    enemies[i].x += ((rand()%3)-1)*0.5f;
                    if(enemies[i].y > HEIGHT + 50) enemies[i].alive=false;
                    if(rand()%100 < 2) enemy_shoot(&enemies[i]);
                }
            }

            for(int i=0;i<MAX_ENEMY_BULLETS;i++){
                if(enemy_bullets[i].alive){
                    enemy_bullets[i].y += 4;
                    if(enemy_bullets[i].y > HEIGHT+20) enemy_bullets[i].alive=false;
                    if(rect_collide(enemy_bullets[i].x, enemy_bullets[i].y, enemy_bullets[i].w, enemy_bullets[i].h,
                                    player.x, player.y, player.w, player.h)){
                        if(!invincible) player.health -= enemy_bullets[i].damage;
                        enemy_bullets[i].alive=false;
                        if(player.health <=0) state = SCORE;
                    }
                }
            }

            for(int b=0;b<MAX_PLAYER_BULLETS;b++){
                if(!player_bullets[b].alive) continue;
                for(int e=0;e<MAX_ENEMIES;e++){
                    if(!enemies[e].alive) continue;
                    if(rect_collide(player_bullets[b].x, player_bullets[b].y, player_bullets[b].w, player_bullets[b].h,
                                    enemies[e].x, enemies[e].y, enemies[e].w, enemies[e].h)){
                        enemies[e].health -= player_bullets[b].damage;
                        if(fx_collision && sound_on) Mix_PlayChannel(-1, fx_collision,0);
                        player_bullets[b].alive=false;
                        if(enemies[e].health <= 0){
                            enemies[e].alive=false; plane_destroy_count++; score+=50;
                            if(fx_blast && sound_on) Mix_PlayChannel(-1,fx_blast,0);
                        } else score+=5;
                        break;
                    }
                }
            }

            for(int e=0;e<MAX_ENEMIES;e++){
                if(!enemies[e].alive) continue;
                if(rect_collide(player.x, player.y, player.w, player.h,
                                enemies[e].x, enemies[e].y, enemies[e].w, enemies[e].h)){
                    if(!invincible){ player.health -= enemies[e].damage; enemies[e].alive=false; }
                    if(player.health <=0) state = SCORE;
                }
            }

            if(player.fuel <= 0) state = SCORE;
        }

        // RENDER
        SDL_SetRenderDrawColor(ren, 0,0,0,255);
        SDL_RenderClear(ren);

        if(state == HOME){
            draw_image(&img_logo, WIDTH/2 - img_logo.w/2, HEIGHT/4);
        } else if(state == GAME){
            draw_image(&img_plane, (int)player.x, (int)player.y);

            for(int i=0;i<MAX_PLAYER_BULLETS;i++){
                if(player_bullets[i].alive){
                    SDL_SetRenderDrawColor(ren, 255,255,0,255);
                    SDL_Rect r = { (int)player_bullets[i].x, (int)player_bullets[i].y, player_bullets[i].w, player_bullets[i].h };
                    SDL_RenderFillRect(ren, &r);
                }
            }

            for(int i=0;i<MAX_ENEMY_BULLETS;i++){
                if(enemy_bullets[i].alive){
                    SDL_SetRenderDrawColor(ren, 255,0,0,255);
                    SDL_Rect r = { (int)enemy_bullets[i].x, (int)enemy_bullets[i].y, enemy_bullets[i].w, enemy_bullets[i].h };
                    SDL_RenderFillRect(ren, &r);
                }
            }

            for(int i=0;i<MAX_ENEMIES;i++){
                if(enemies[i].alive && enemies[i].img && enemies[i].img->tex){
                    SDL_Rect er = { (int)enemies[i].x, (int)enemies[i].y, enemies[i].w, enemies[i].h };
                    SDL_RenderCopy(ren, enemies[i].img->tex, NULL, &er);
                }
            }

            draw_hud();
        } else if(state == SCORE){
            char buf[64];
            snprintf(buf,sizeof(buf),"Game Over! Score: %d", score);
            SDL_Color col = {255,0,0,255};
            if(font_large){
                SDL_Surface *surf = TTF_RenderText_Solid(font_large, buf, col);
                if(surf){
                    SDL_Texture *tex = SDL_CreateTextureFromSurface(ren,surf);
                    SDL_Rect dst = { WIDTH/2 - surf->w/2, HEIGHT/4, surf->w, surf->h };
                    SDL_RenderCopy(ren, tex, NULL, &dst);
                    SDL_DestroyTexture(tex);
                    SDL_FreeSurface(surf);
                }
            }
        }

        SDL_RenderPresent(ren);
        Uint32 frame_time = SDL_GetTicks() - frame_start;
        if(frame_time < ticks_per_frame) SDL_Delay(ticks_per_frame - frame_time);
    }

    // Cleanup
    for(int i=0;i<3;i++) for(int j=0;j<2;j++) if(img_enemies[i][j].tex) SDL_DestroyTexture(img_enemies[i][j].tex);
    SDL_DestroyTexture(img_plane.tex); SDL_DestroyTexture(img_logo.tex); SDL_DestroyTexture(img_fighter.tex);
    SDL_DestroyRenderer(ren); SDL_DestroyWindow(win);
    Mix_FreeChunk(fx_shoot); Mix_FreeChunk(fx_click); Mix_FreeChunk(fx_collision); Mix_FreeChunk(fx_blast); Mix_FreeChunk(fx_fuel);
    Mix_FreeMusic(music);
    TTF_CloseFont(font_large); TTF_CloseFont(font_small);
    IMG_Quit(); Mix_CloseAudio(); SDL_Quit(); TTF_Quit();

    return 0;
}
